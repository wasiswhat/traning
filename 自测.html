<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telc C1 Master (Ultimate)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --panel-bg: #ffffff;
            --border: #dcdcdc;
            --correct: #d4edda;
            --wrong: #f8d7da;
            --highlight: #e8f4fc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            height: 100vh;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        h1 { font-size: 18px; margin: 0; display: flex; align-items: center; gap: 10px; }
        .controls { display: flex; gap: 10px; align-items: center; }

        .btn {
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .file-upload { position: relative; overflow: hidden; display: inline-block; background-color: #e67e22; }
        .file-upload:hover { background-color: #d35400; }
        input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; font-size: 100px; }
        
        .btn-shuffle { background-color: #f1c40f; color: #2c3e50; }
        .btn-check { background-color: #27ae60; }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }

        /* Left Panel (Options Pool for LV1/HV1) */
        .left-panel {
            width: 300px;
            min-width: 0; /* Allow collapsing */
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            transition: width 0.3s;
        }
        
        /* If type is multiple choice, hide left panel */
        .left-panel.hidden { width: 0; border: none; }

        .panel-header {
            padding: 12px 15px;
            background: #f8f9fa;
            font-weight: bold;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            white-space: nowrap;
        }

        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }

        /* Option Cards (Left) */
        .option-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            gap: 10px;
            cursor: pointer;
        }
        .option-card:hover { border-color: var(--accent); background: #fbfbfb; }
        .option-card.is-used { opacity: 0.5; text-decoration: line-through; background: #eee; }
        
        .opt-badge {
            background: var(--primary);
            color: white;
            min-width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* Resizer */
        .resizer {
            width: 8px;
            background: #e0e0e0;
            cursor: col-resize;
            flex-shrink: 0;
            z-index: 10;
        }
        .resizer.hidden { display: none; }

        /* Right Panel (Content) */
        .right-panel {
            flex: 1;
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 300px;
        }

        .instruction {
            background: var(--highlight);
            border-left: 4px solid var(--accent);
            padding: 10px 15px;
            margin-bottom: 25px;
            color: #555;
            font-style: italic;
        }

        .text-body {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            max-width: 900px;
            margin: 0 auto;
            user-select: text;
        }

        /* --- Input Types --- */

        /* 1. Dropdown (LV1 / HV1) */
        select.gap-select {
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            padding: 2px 5px;
            margin: 0 4px;
            font-weight: bold;
            color: var(--primary);
            background: white;
            cursor: pointer;
            min-width: 60px;
        }
        select.gap-select:focus { border-color: var(--accent); outline: none; }

        /* 2. Multiple Choice (HV2) */
        .mc-question {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .mc-title { font-weight: bold; margin-bottom: 15px; display: flex; gap: 10px; }
        .mc-id { color: var(--accent); }
        
        .mc-options { display: flex; flex-direction: column; gap: 8px; }
        .mc-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .mc-option:hover { background: #f9f9f9; border-color: #bbb; }
        .mc-option.selected { background: var(--highlight); border-color: var(--accent); font-weight: bold; }
        
        .mc-option.correct { background: var(--correct); border-color: #28a745; }
        .mc-option.wrong { background: var(--wrong); border-color: #dc3545; opacity: 0.7; }

        /* Match Row (HV1) */
        .match-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .match-label { width: 150px; font-weight: bold; }

        /* Feedback */
        #feedback-bar {
            background: #333; color: white; padding: 12px;
            text-align: center; font-weight: bold; display: none;
        }
        
        /* Empty State */
        #empty-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; color: #aaa; text-align: center;
        }
        .drop-icon { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }

    </style>
</head>
<body>

    <header>
        <h1>ðŸ‡©ðŸ‡ª Telc Master <span id="exam-title" style="font-size:14px; font-weight:normal; opacity:0.8; margin-left:10px;"></span></h1>
        <div class="controls">
            <div class="file-upload btn">
                <span>ðŸ“‚ Datei laden (.json)</span>
                <input type="file" id="fileInput" accept=".json">
            </div>
            <button class="btn btn-shuffle" onclick="renderContent()" id="btn-mix" style="display:none">ðŸ”€ Mischen</button>
            <button class="btn btn-check" onclick="checkAnswers()" id="btn-check" style="display:none">âœ… PrÃ¼fen</button>
        </div>
    </header>

    <div class="main-container">
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">Optionen</div>
            <div class="scroll-area" id="options-pool"></div>
        </div>
        
        <div class="resizer" id="resizer"></div>

        <div class="right-panel">
            <div class="scroll-area">
                <div id="empty-state">
                    <div class="drop-icon">ðŸ“‚</div>
                    <h3>Keine Aufgabe geladen</h3>
                    <p>Laden Sie eine JSON-Datei fÃ¼r LV1, HV1 oder HV2.</p>
                </div>
                <div id="quiz-content" style="display:none;">
                    <div id="instruction" class="instruction"></div>
                    <div id="question-area" class="text-body"></div>
                </div>
            </div>
            <div id="feedback-bar"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let shuffledPool = []; // For GapFill/Matching
        let shuffledMC = [];   // For Multiple Choice

        // --- File Loading ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    loadExam(json);
                } catch (err) { alert("UngÃ¼ltiges JSON-Format!"); }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function loadExam(data) {
            currentData = data;
            
            // Toggle UI based on type
            const isMC = (data.type === 'multiple_choice');
            const leftPanel = document.getElementById('leftPanel');
            const resizer = document.getElementById('resizer');
            
            if (isMC) {
                leftPanel.classList.add('hidden');
                resizer.classList.add('hidden');
            } else {
                leftPanel.classList.remove('hidden');
                resizer.classList.remove('hidden');
            }

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            document.getElementById('btn-mix').style.display = 'flex';
            document.getElementById('btn-check').style.display = 'flex';
            document.getElementById('exam-title').textContent = ` - ${data.title || ''}`;
            document.getElementById('instruction').textContent = data.instruction || '';
            document.getElementById('feedback-bar').style.display = 'none';

            renderContent();
        }

        function renderContent() {
            const area = document.getElementById('question-area');
            area.innerHTML = '';
            document.getElementById('feedback-bar').style.display = 'none';

            // 1. Multiple Choice (HV2) Logic
            if (currentData.type === 'multiple_choice') {
                shuffledMC = []; // Reset storage
                
                currentData.questions.forEach((q, qIdx) => {
                    // Create object for this question
                    let qObj = { 
                        id: q.id, 
                        correctIndex: q.answer,
                        options: [] 
                    };

                    // Shuffle options
                    let tempOpts = q.options.map((txt, idx) => ({ text: txt, originalIdx: idx }));
                    // Simple shuffle
                    for (let i = tempOpts.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [tempOpts[i], tempOpts[j]] = [tempOpts[j], tempOpts[i]];
                    }
                    qObj.options = tempOpts;
                    shuffledMC.push(qObj);

                    // Render HTML
                    let card = document.createElement('div');
                    card.className = 'mc-question';
                    card.setAttribute('data-qidx', qIdx);
                    
                    let html = `<div class="mc-title"><span class="mc-id">${q.id})</span> <span>${q.text}</span></div>`;
                    html += `<div class="mc-options">`;
                    
                    tempOpts.forEach((opt, oIdx) => {
                        html += `
                            <div class="mc-option" onclick="selectMC(this, ${qIdx}, ${opt.originalIdx})">
                                <div style="width:20px;font-weight:bold;">${String.fromCharCode(65+oIdx)}</div>
                                <div>${opt.text}</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                    card.innerHTML = html;
                    area.appendChild(card);
                });

            } 
            // 2. Pool-based Logic (LV1 / HV1)
            else {
                // Shuffle global pool
                let temp = currentData.options.map((text, idx) => ({ originalIndex: idx, text: text }));
                for (let i = temp.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [temp[i], temp[j]] = [temp[j], temp[i]];
                }
                shuffledPool = temp.map((opt, idx) => ({ ...opt, label: String.fromCharCode(97 + idx) }));

                // Render Left Panel
                const poolDiv = document.getElementById('options-pool');
                poolDiv.innerHTML = '';
                shuffledPool.forEach(opt => {
                    let div = document.createElement('div');
                    div.className = 'option-card';
                    div.onclick = function() { this.classList.toggle('is-used'); };
                    div.innerHTML = `<div class="opt-badge">${opt.label}</div><div>${opt.text}</div>`;
                    poolDiv.appendChild(div);
                });

                // Prepare Select Options
                let selectHTML = `<option value="">--</option>`;
                shuffledPool.forEach(opt => {
                    selectHTML += `<option value="${opt.originalIndex}">${opt.label}</option>`;
                });

                // Render Right Panel
                if (currentData.type === 'matching') {
                    currentData.items.forEach(item => {
                        let row = document.createElement('div');
                        row.className = 'match-row';
                        row.innerHTML = `
                            <div class="match-label">${item.label}</div>
                            <div style="flex:1"><select class="gap-select" data-id="${item.id}">${selectHTML}</select></div>
                        `;
                        area.appendChild(row);
                    });
                } else {
                    let text = currentData.text.replace(/\n\n/g, '<br><br>').replace(/\n/g, ' '); // Logic for paragraphs
                    text = text.replace(/\{(\d+)\}/g, (match, id) => {
                        return `<select class="gap-select" data-id="${id}">${selectHTML}</select>`;
                    });
                    area.innerHTML = text;
                }
            }
        }

        // --- Interaction Logic ---

        // For MC Selection
        window.selectMC = function(el, qIdx, answerIdx) {
            // Remove selected from siblings
            let parent = el.parentElement;
            let siblings = parent.querySelectorAll('.mc-option');
            siblings.forEach(s => s.classList.remove('selected'));
            
            // Add to clicked
            el.classList.add('selected');
            el.setAttribute('data-val', answerIdx);
        };

        function checkAnswers() {
            let correct = 0;
            let total = 0;

            if (currentData.type === 'multiple_choice') {
                const questions = document.querySelectorAll('.mc-question');
                total = questions.length;
                
                questions.forEach((card, idx) => {
                    const data = shuffledMC[idx];
                    const selectedEl = card.querySelector('.mc-option.selected');
                    const optionsEl = card.querySelectorAll('.mc-option');
                    
                    // Reset styles
                    optionsEl.forEach(opt => opt.classList.remove('correct', 'wrong'));

                    if (selectedEl) {
                        const userAns = parseInt(selectedEl.getAttribute('data-val'));
                        if (userAns === data.correctIndex) {
                            selectedEl.classList.add('correct');
                            correct++;
                        } else {
                            selectedEl.classList.add('wrong');
                            // Highlight correct one
                            // We need to find which DOM element corresponds to the correct answer
                            // The DOM order matches shuffledMC[idx].options order
                            // We need to find the option object where originalIdx === data.correctIndex
                            let correctDomIdx = data.options.findIndex(o => o.originalIdx === data.correctIndex);
                            if(correctDomIdx !== -1) optionsEl[correctDomIdx].classList.add('correct');
                        }
                    } else {
                         // User didn't select anything, highlight correct answer
                         let correctDomIdx = data.options.findIndex(o => o.originalIdx === data.correctIndex);
                         if(correctDomIdx !== -1) optionsEl[correctDomIdx].classList.add('wrong'); // Mark missed
                    }
                });

            } else {
                // GapFill / Matching
                const selects = document.querySelectorAll('.gap-select');
                total = selects.length;
                selects.forEach(sel => {
                    const qId = sel.getAttribute('data-id');
                    const userVal = parseInt(sel.value);
                    const correctVal = currentData.solution[qId];
                    sel.classList.remove('correct', 'wrong');
                    
                    if (!isNaN(userVal) && userVal === correctVal) {
                        sel.classList.add('correct');
                        correct++;
                    } else {
                        sel.classList.add('wrong');
                    }
                });
            }

            const fb = document.getElementById('feedback-bar');
            fb.style.display = 'block';
            if (correct === total) {
                fb.style.backgroundColor = '#27ae60';
                fb.textContent = `ðŸŽ‰ Perfekt! (${correct}/${total})`;
            } else {
                fb.style.backgroundColor = '#c0392b';
                fb.textContent = `Ergebnis: ${correct} von ${total} richtig.`;
            }
        }

        // --- Resizer Logic ---
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('leftPanel');
        let isResizing = false;

        resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            let w = e.clientX;
            if (w < 200) w = 200; if (w > 600) w = 600;
            leftPanel.style.width = w + 'px';
        });
        document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; });

    </script>
</body>
</html>